name: Deploy Dokploy Compose
description: Update and deploy a Dokploy Compose application

inputs:
  api_url:
    description: "The Dokploy API URL"
    required: true
    default: "https://api.dokploy.com/v1"
  api_key:
    description: "The Dokploy API key"
    required: true
  compose_id:
    description: "The Dokploy Compose ID to update and deploy"
    required: true
  image:
    description: "The Docker image to set in the Compose file"
    required: true

runs:
  using: "composite"
  steps:
    - name: Update Dokploy compose application and trigger deployment
      shell: bash
      run: |
        echo "Updating Dokploy Compose application..."
        # Mask sensitive inputs in logs
        echo "::add-mask::${{ inputs.api_url }}"
        echo "::add-mask::${{ inputs.api_key }}"
        echo "::add-mask::${{ inputs.compose_id }}"

        update_response_code=$(curl -sS -o /dev/null -w "%{http_code}" -X 'POST' "${{ inputs.api_url }}/compose.update" -H 'accept: application/json' -H 'Content-Type: application/json' -H "x-api-key: ${{ inputs.api_key }}" -d '{
          "composeId": "'${{ inputs.compose_id }}'",
          "composeFile": "services:\n  app:\n    image: '${{ inputs.image }}'\n    restart: always\n    env_file:\n      - .env"
        }')
        echo "update_status_code=$update_response_code" >> $GITHUB_OUTPUT
        if [ "$update_response_code" -ne 200 ]; then
          echo "Failed to update Dokploy Compose application. HTTP status code: $update_response_code"
          exit 1
        fi

        echo "Dokploy Compose application updated successfully."

        echo "Triggering deployment for Dokploy Compose application..."

        deploy_response_code=$(curl -sS -o /dev/null -w "%{http_code}" -X 'POST' "${{ inputs.api_url }}/compose.deploy" -H 'accept: application/json' -H 'Content-Type: application/json' -H "x-api-key: ${{ inputs.api_key }}" -d '{
          "composeId": "'${{ inputs.compose_id }}'",
          "title": "Deploy from CI",
          "description": "Deploying the latest changes from the CI pipeline. image: '${{ inputs.image }}'"
        }')

        echo "deploy_status_code=$deploy_response_code" >> $GITHUB_OUTPUT
        if [ "$deploy_response_code" -ne 200 ]; then
          echo "Failed to trigger deployment for Dokploy Compose application. HTTP status code: $deploy_response_code"
          exit 1
        fi
        echo "Dokploy Compose application updated and deployment triggered."
