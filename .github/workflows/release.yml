name: Changeset Release

on:
  workflow_call:
    secrets:
      STUDIOCMS_GIT_BOT_APP_ID:
        description: 'The GitHub App ID for authenticating with the GitHub API'
        required: true
      STUDIOCMS_GIT_BOT_PRIVATE_KEY:
        description: 'The GitHub App Private Key for authenticating with the GitHub API'
        required: true
      DISCORD_WEBHOOK_RELEASE:
        description: 'The Discord Webhook URL for posting release notifications'
        required: false
    inputs:
      build-cmd:
        type: 'string'
        description: 'The build command to run before running the release'
        required: true
        default: 'pnpm ci:build'
      RoleMentionId:
        type: 'string'
        description: 'The Discord Role ID to mention in the release notification (optional)'
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max_old_space_size=4096"
    steps:
      - name: Setup Apollo Git Bot
        id: bot-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ secrets.STUDIOCMS_GIT_BOT_APP_ID }}
          private-key: ${{ secrets.STUDIOCMS_GIT_BOT_PRIVATE_KEY }}
          
      - name: Checkout Repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Install Tools & Dependencies
        uses: withstudiocms/automations/.github/actions/install@89b4e8b178b4f8b3e78a1b8d935ab47a31393888 # main

      - name: Run Build
        run: ${{ inputs.build-cmd }}
          
      - name: Setup git user
        shell: bash
        run: |
          git config --global user.name "apollo-git-bot[bot]"
          git config --global user.email "234251158+apollo-git-bot[bot]@users.noreply.github.com"

      - name: Run Changeset Release
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba # v1.5.3
        with:
          # If USE_GITHUB_BOT is true we don't want Changesets to do anything user related
          setupGitUser: false
          commit: "ðŸ‘· [ci]: Version Packages"
          title: "ðŸ‘· [ci]: Ready for Release"
          version: pnpm changeset version
          publish: pnpm changeset publish
        env:
          GITHUB_TOKEN: ${{ steps.bot-token.outputs.token }}
    
      - name: Add Label to CI PR
        if: ${{ steps.changesets.outputs.hasChangesets == 'true' }}
        run: gh pr edit "$PR_URL" --add-label "ci"
        shell: bash
        env:
          PR_URL: ${{ steps.changesets.outputs.pull_request_url }}
          GITHUB_TOKEN: ${{ steps.bot-token.outputs.token }}

      - name: Initiate Release Bot
        if: ${{ steps.changesets.outputs.published == 'true' }}
        uses: ./.github/actions/releasebot
        with:
          repository: ${{ github.repository }}
          CWD: ${{ github.workspace }}
          PublishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RELEASE }}
          RoleMentionId: ${{ inputs.RoleMentionId }}