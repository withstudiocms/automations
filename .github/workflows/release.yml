name: Changeset Release

on:
  workflow_call:
    secrets:
      STUDIOCMS_GIT_BOT_APP_ID:
        description: 'The GitHub App ID for authenticating with the GitHub API'
        required: true
      STUDIOCMS_GIT_BOT_PRIVATE_KEY:
        description: 'The GitHub App Private Key for authenticating with the GitHub API'
        required: true
      DISCORD_WEBHOOK_RELEASE:
        description: 'The Discord Webhook URL for posting release notifications'
        required: false
    inputs:
      build-cmd:
        type: 'string'
        description: 'The build command to run before running the release'
        required: true
      RoleMentionId:
        type: 'string'
        description: 'The Discord Role ID to mention in the release notification (optional)'
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    env:
      NODE_OPTIONS: "--max_old_space_size=4096"
    steps:
      - name: Setup Apollo Git Bot
        id: bot-token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ secrets.STUDIOCMS_GIT_BOT_APP_ID }}
          private-key: ${{ secrets.STUDIOCMS_GIT_BOT_PRIVATE_KEY }}
          
      - name: Checkout Repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install Tools & Dependencies
        uses: withstudiocms/automations/.github/actions/install@main

      - name: Run Build
        run: ${{ inputs.build-cmd }}
          
      - name: Setup git user
        shell: bash
        run: |
          git config --global user.name "apollo-git-bot[bot]"
          git config --global user.email "234251158+apollo-git-bot[bot]@users.noreply.github.com"

      - name: Run Changeset Release
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba # v1.5.3
        with:
          # If USE_GITHUB_BOT is true we don't want Changesets to do anything user related
          setupGitUser: false
          commit: "ðŸ‘· [ci]: Version Packages"
          title: "ðŸ‘· [ci]: Ready for Release"
          version: pnpm changeset version
          publish: pnpm changeset publish
        env:
          GITHUB_TOKEN: ${{ steps.bot-token.outputs.token }}
    
      - name: Add Label to CI PR
        if: ${{ steps.changesets.outputs.hasChangesets == 'true' }}
        run: |
          if [ -n "$PR_URL" ]; then
            echo "Adding 'ci' label to PR: $PR_URL"
            if gh pr edit "$PR_URL" --add-label "ci"; then
              echo "Successfully added label to PR"
            else
              echo "Failed to add label to PR, but continuing workflow"
            fi
          else
            echo "No PR URL available, skipping label addition"
          fi
        shell: bash
        env:
          PR_URL: ${{ steps.changesets.outputs.pull_request_url }}
          GITHUB_TOKEN: ${{ steps.bot-token.outputs.token }}

      - name: Initiate Release Bot
        if: ${{ steps.changesets.outputs.published == 'true' }}
        uses: withstudiocms/automations/.github/actions/releasebot@main
        with:
          repository: ${{ github.repository }}
          CWD: ${{ github.workspace }}
          PublishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_RELEASE }}
          RoleMentionId: ${{ inputs.RoleMentionId }}