name: Send discord Embed

on:
  workflow_call:
    secrets:
      DISCORD_WEBHOOK:
        description: >
          URL of a Discord webhook. To create one:
            1. Find the channel you want to post a message in.
            2. Right-click and select “Edit Channel”.
            3. Navigate to “Integrations” > “View Webhooks”.
            4. Click “New Webhook” and copy the URL for your newly created webhook.
        required: true
    inputs:
      CONTENT:
        description: >
          The non-embedded Content for the discord message
        type: string
        required: false
      EMBEDS:
        description: >
          A JSON array of the discord embed messages
        default: >
          [
            {
              "id": 661098315,
              "description": "Hello World!",
              "fields": [],
              "author": {
                "name": "Hello World!",
                "icon_url": "https://github.com/withstudiocms/studiocms.dev/blob/main/assets/logo-discord.png?raw=true"
              },
              "title": "Hello!"
            }
          ]
        type: string
        required: false
      COMPONENTS:
        description: >
          A JSON array of the discord components
        default: > 
          []
        type: string
        required: false
      ACTIONS:
        description: >
          A JSON object for Discord actions
        default: > 
          {}
        type: string
        required: false

jobs:
  runner:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Message
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          CONTENT: ${{ inputs.CONTENT }}
          EMBEDS: ${{ inputs.EMBEDS }}
          COMPONENTS: ${{ inputs.COMPONENTS }}
          ACTIONS: ${{ inputs.ACTIONS }}
        with:
          script: |
            const { WEBHOOK_URL, CONTENT, EMBEDS, COMPONENTS, ACTIONS } = process.env
            await fetch(WEBHOOK_URL, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                content: CONTENT,
                tts: false,
                embeds: EMBEDS,
                components: COMPONENTS,
                actions: ACTIONS
              })
            })
      
